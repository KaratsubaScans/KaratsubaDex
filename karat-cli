#!/usr/bin/make -f

# KARAT-CLI =-=-=-=-=-=-=-=-=
# requires sponge (from moreutils) and jq

## config variables
SITE_URL:=https://karatsubascans.com

## no trailing slash in dirs
CONTENT_DIR:=content
RSS_DIR:=feeds
OUT_DIR:=manga
TEMPLATE_DIR:=templates

MANGA_LIST=$(subst .json,,$(shell ls $(CONTENT_DIR)))

.PHONY: help init build clean new-manga new-chapter

help:
	@echo 'karat-cli help|build|clean|new-manga|new-chapter'

build: $(OUT_DIR)/$(addsuffix .html,$(MANGA_LIST))

new-manga:
	@if [ -z "$(name)" ]; then \
		echo "Missing name field."; exit 1; \
	fi; \
	echo "Creating new manga page for '$(name)'"; \
	export KS_MANGATITLE="$(name)"; \
	content_file="$(CONTENT_DIR)/$$KS_MANGATITLE.json"; \
	envsubst < "$(TEMPLATE_DIR)/mangainfo.template.json" > "$$content_file"; \
	"$$EDITOR" "$$content_file"; \
	echo "Once you are satisfied with your changes, you can rebuild to generate the html page."

new-chapter:
	@if [ -z "$(name)" ]; then \
		echo "Missing name field."; exit 1; \
	fi; \
	chapter_info=`mktemp`; \
	cat "$(TEMPLATE_DIR)/mangachapter.template.json" > "$$chapter_info"; \
	"$$EDITOR" "$$chapter_info"; \
	sed -i '1s/^/.chapters += /' "$$chapter_info"; \
	jq -f "$$chapter_info" "$(CONTENT_DIR)/$(name).json" | sponge "$(CONTENT_DIR)/$(name).json"; \
	rm "$$chapter_info"

clean:
	@# ask user for confirm here
	@echo "cleaning..."; \
	rm $(OUT_DIR)/*

$(OUT_DIR)/%.html: $(CONTENT_DIR)/%.json
	@echo "building manga page: $@";\
	export KS_MANGATITLE=$(notdir $(basename $@)); \
	export KS_DESCRIPTION=`jq '.description' "$^"`; \
	envsubst < $(TEMPLATE_DIR)/head.html >> "$@"; \
	envsubst < $(TEMPLATE_DIR)/mangapage.template.html >> "$@"; \
	envsubst < $(TEMPLATE_DIR)/foot.html >> "$@"; \
	chapter_html=`mktemp`; \
	for k in `jq -c '.chapters | keys | .[]' "$(CONTENT_DIR)/$$KS_MANGATITLE.json"`; do \
		chapter=`jq -rc ".chapters[$$k]" "$(CONTENT_DIR)/$$KS_MANGATITLE.json"`; \
		export KS_CHAPTERNAME=`echo "$$chapter" | jq -r '.chapter_name'`; \
		export KS_PNGLINK=`echo "$$chapter" | jq -r '.png_link'`; \
		export KS_ZIPLINK=`echo "$$chapter" | jq -r '.zip_link'`; \
		export KS_MESSAGE=`echo "$$chapter" | jq -r '.message'`; \
		envsubst < $(TEMPLATE_DIR)/mangapage_chapter.template.html > "$$chapter_html"; \
		sed -i "/<!-- KS_CHAPTERLIST -->/r $$chapter_html" "$@"; \
	done; \
	rm $$chapter_html;

# $(RSS_DIR)/%.xml:
# 	@echo "feeds"
