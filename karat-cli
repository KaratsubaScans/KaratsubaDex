#!/usr/bin/make -f

## config variables
SITE_URL:=https://karatsubascans.com

## no trailing slash in dirs
CONTENT_DIR:=content
RSS_DIR:=feeds
OUT_DIR:=manga
TEMPLATE_DIR:=templates

MANGA_LIST=$(subst .json,,$(shell ls $(CONTENT_DIR)))

.PHONY: help init build clean new-manga new-chapter

help:
	@echo 'karat-cli help|build|clean|new-manga|new-chapter'

# prob dont need this one
init:
	@echo "initializing directories"

build: $(OUT_DIR)/$(addsuffix .html,$(MANGA_LIST))

new-manga:
	@if [ -z "$(name)" ]; then \
		echo "Missing name field."; exit 1; \
	fi; \
	echo "Creating new manga page for '$(name)'"; \
	export KS_MANGATITLE="$(name)"; \
	content_file="$(CONTENT_DIR)/$$KS_MANGATITLE.json"; \
	envsubst < "$(TEMPLATE_DIR)/mangainfo.template.json" > "$$content_file"; \
	"$$EDITOR" "$$content_file"; 
	echo "Once you are satisfied with your changes, you can rebuild to generate the html page."

new-chapter:
	@echo "new chapter"

clean:
	@# ask user for confirm here
	@echo "cleaning..."; \
	rm $(OUT_DIR)/*

$(OUT_DIR)/%.html: $(CONTENT_DIR)/%.json
	@echo "building manga page: $@";\
	export KS_MANGATITLE=$(notdir $(basename $@)); \
	export KS_DESCRIPTION=$(shell jq '.description' "$^"); \
	envsubst < $(TEMPLATE_DIR)/head.html >> "$@"; \
	envsubst < $(TEMPLATE_DIR)/mangapage.template.html >> "$@"; \
	envsubst < $(TEMPLATE_DIR)/foot.html >> "$@";

# $(RSS_DIR)/%.xml:
# 	@echo "feeds"

